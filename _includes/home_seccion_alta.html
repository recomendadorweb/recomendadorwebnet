{%- assign _title = include.title | default: "Sección" -%}
{%- assign _see_all_label = include.see_all_label | default: "see all" -%}
{%- assign _offset = include.offset | default: 0 -%}
{%- assign _limit = include.limit | default: 4 -%}
{%- assign _desc = include.description | default: include.descripcion | default: "" -%}

{%- comment -%} Siempre usamos site.pages {%- endcomment -%}
{%- assign base = site.pages -%}

{%- if include.category -%}
  {%- assign base = base | where_exp: "p", "p.categories contains include.category" -%}
{%- endif -%}
{%- if include.tag -%}
  {%- assign base = base | where_exp: "p", "p.tags contains include.tag" -%}
{%- endif -%}
{%- if include.require_keyword -%}
  {%- assign base = base | where_exp: "p", "p.keywords" -%}
{%- endif -%}
{%- if include.contains_keyword -%}
  {%- assign _kw = include.contains_keyword | downcase -%}
  {%- assign filtered_kw = "" | split: "" -%}
  {%- for p in base -%}
    {%- assign k = p.keywords -%}
    {%- assign k_str = k | join: ',' | default: k | downcase -%}
    {%- if k_str and (k_str contains _kw) -%}
      {%- assign filtered_kw = filtered_kw | push: p -%}
    {%- endif -%}
  {%- endfor -%}
  {%- assign base = filtered_kw -%}
{%- endif -%}

{%- comment -%} ==== FILTRO POR CATEGORÍA (front matter 'categoria' o 'categorias') ==== {%- endcomment -%}
{%- assign _categoria_raw = include.categoria | default: include.categorias -%}
{%- if _categoria_raw and _categoria_raw != "" -%}
  {%- comment -%} Normalizamos la lista pedida en el include (string o array) {%- endcomment -%}
  {%- assign _cats_param_list = _categoria_raw -%}
  {%- unless _cats_param_list.first -%}
    {%- assign _norm = _categoria_raw
        | replace: ", ", "," | replace: " ,", ","
        | replace: " |", "|" | replace: "| ", "|"
      -%}
    {%- assign _cats_param_list = _norm | split: "|" | join: "|" | split: "," | join: "|" | split: "|" -%}
  {%- endunless -%}

  {%- assign cats_list = "" | split: "" -%}
  {%- for c in _cats_param_list -%}
    {%- assign c_norm = c | downcase | strip -%}
    {%- if c_norm != "" -%}
      {%- assign cats_list = cats_list | push: c_norm -%}
    {%- endif -%}
  {%- endfor -%}
  {%- assign cats_list = cats_list | uniq -%}

  {%- assign filtradas_cat = "" | split: "" -%}
  {%- for p in base -%}
    {%- assign match_cat = false -%}

    {%- comment -%} p.categoria puede ser string "gaming, tecnologia" o array; también admitimos p.categorias {%- endcomment -%}
    {%- assign pcat_raw = p.categoria | default: p.categorias -%}
    {%- if pcat_raw -%}
      {%- assign pcat_list = pcat_raw -%}
      {%- unless pcat_list.first -%}
        {%- assign pnorm = pcat_raw
            | replace: ", ", "," | replace: " ,", ","
            | replace: " |", "|" | replace: "| ", "|"
          -%}
        {%- assign pcat_list = pnorm | split: "|" | join: "|" | split: "," | join: "|" | split: "|" -%}
      {%- endunless -%}

      {%- for wanted in cats_list -%}
        {%- if match_cat -%}{% break %}{%- endif -%}
        {%- for pc in pcat_list -%}
          {%- assign pc_norm = pc | downcase | strip -%}
          {%- if pc_norm == wanted -%}
            {%- assign match_cat = true -%}
            {%- break -%}
          {%- endif -%}
        {%- endfor -%}
      {%- endfor -%}
    {%- endif -%}

    {%- if match_cat -%}
      {%- assign filtradas_cat = filtradas_cat | push: p -%}
    {%- endif -%}
  {%- endfor -%}

  {%- assign base = filtradas_cat -%}
{%- endif -%}

{%- comment -%} ==== FILTRO POR RUTAS usando **carpeta** (exactas o recursivas) ==== {%- endcomment -%}
{%- assign _carpeta_raw = include.carpeta | default: include.dirs -%}
{%- assign _recursiva = include.carpeta_recursiva | default: include.dirs_recursive | default: true -%}

{%- if _carpeta_raw and _carpeta_raw != "" -%}
  {%- assign carpetas_list = _carpeta_raw -%}
  {%- unless carpetas_list.first -%}
    {%- assign _norm = _carpeta_raw
        | replace: ", ", ","
        | replace: " ,", ","
        | replace: " |", "|"
        | replace: "| ", "|"
        | replace: ",", "|"
      -%}
    {%- assign carpetas_list = _norm | split: "|" -%}
  {%- endunless -%}

  {%- assign carpetas_list = carpetas_list | uniq -%}
  {%- assign filtradas = "" | split: "" -%}

  {%- for p in base -%}
    {%- assign match_dir = false -%}

    {%- assign path_base = p.dir | default: p.url | default: "" -%}
    {%- if path_base != "" -%}
      {%- assign path_norm = path_base -%}
      {%- assign first_char_pb = path_norm | slice: 0, 1 -%}
      {%- if first_char_pb != "/" -%}{%- assign path_norm = "/" | append: path_norm -%}{%- endif -%}
      {%- assign last_char_pb = path_norm | slice: -1, 1 -%}
      {%- if last_char_pb != "/" -%}{%- assign path_norm = path_norm | append: "/" -%}{%- endif -%}
    {%- else -%}
      {%- assign path_norm = "" -%}
    {%- endif -%}

    {%- for d in carpetas_list -%}
      {%- assign d_norm = d | strip -%}
      {%- if d_norm == "" -%}{% continue %}{%- endif -%}
      {%- assign first_char = d_norm | slice: 0, 1 -%}
      {%- if first_char != "/" -%}{%- assign d_norm = "/" | append: d_norm -%}{%- endif -%}
      {%- assign last_char = d_norm | slice: -1, 1 -%}
      {%- if last_char != "/" -%}{%- assign d_norm = d_norm | append: "/" -%}{%- endif -%}

      {%- if _recursiva -%}
        {%- assign d_len = d_norm | size -%}
        {%- assign prefix = path_norm | slice: 0, d_len -%}
        {%- if prefix == d_norm -%}
          {%- assign match_dir = true -%}
          {%- break -%}
        {%- endif -%}
      {%- else -%}
        {%- if path_norm == d_norm -%}
          {%- assign match_dir = true -%}
          {%- break -%}
        {%- endif -%}
      {%- endif -%}
    {%- endfor -%}

    {%- if match_dir -%}
      {%- assign filtradas = filtradas | push: p -%}
    {%- endif -%}
  {%- endfor -%}

  {%- assign base = filtradas -%}
{%- endif -%}

{%- assign base = base | where_exp: "p", "p.date" -%}
{%- assign list_sorted = base | sort: "date" | reverse -%}

{%- if include.exclude_urls and include.exclude_urls.size > 0 -%}
  {%- assign filtered = "" | split: "" -%}
  {%- for p in list_sorted -%}
    {%- unless include.exclude_urls contains p.url -%}
      {%- assign filtered = filtered | push: p -%}
    {%- endunless -%}
  {%- endfor -%}
  {%- assign list_sorted = filtered -%}
{%- endif -%}

{%- assign list_offset = list_sorted | slice: _offset, 999 -%}
{%- assign items = list_offset | slice: 0, _limit -%}
{%- assign main = items | first -%}
{%- assign subs = items | slice: 1, 3 -%}

<div class="hero-divider"></div>
<section class="split-feature" aria-label="{{ _title | escape }}">
  <header class="sf-head">
    <h2 class="sf-title">{{ _title }}</h2>
    <nav class="sf-links">
      {%- if include.see_all_url -%}
        <a href="{{ include.see_all_url | relative_url }}">Ver todo en {{ include.title | default: 'esta categoría' }}</a>
      {%- endif -%}
    </nav>
  </header>

  {%- if _desc != "" -%}
    <p class="sf-desc">{{ _desc }}</p>
  {%- endif -%}

  {%- if main -%}
    <div class="sf-hero">
      <a class="sf-media" href="{{ main.url | relative_url }}">
        <img src="{{ main.imagenhome | default: main.image | default: '/global/images/placeholder.webp' }}" alt="{{ main.title | escape }}">
      </a>

      <div class="sf-side">
        {%- for p in subs -%}
        {%- comment -%} FECHA desde data por tipo con formato DD/MM/YYYY {%- endcomment -%}
        {%- assign _tipo = p.tipo | downcase -%}
        {%- assign _productos_data = site.data[_tipo].productos -%}
        {%- assign _titulo1 = site.data[_tipo].cabecera.titulo -%}
        {%- assign _actu_val = _productos_data.actualizacion | default: "" -%}
        {%- assign _actu_fmt = "" -%}
        {%- if _actu_val != "" -%}
          {%- if _actu_val contains "-" or _actu_val contains ":" or _actu_val contains "T" -%}
            {%- assign _actu_fmt = _actu_val | date: "%d/%m/%Y" -%}
          {%- elsif _actu_val contains "/" -%}
            {%- assign _actu_fmt = _actu_val -%}
          {%- else -%}
            {%- assign _actu_fmt = _actu_val | date: "%d/%m/%Y" -%}
          {%- endif -%}
        {%- endif -%}

        <article class="sf-item">
          <a class="sf-thumb" href="{{ p.url | relative_url }}">
            <img src="{{ p.imagenhome | default: p.image | default: '/global/images/placeholder.webp' }}" alt="{{ _titulo1 | escape }}" loading="lazy">
          </a>
          <div class="sf-body">
            <h3 class="sf-item-title"><a href="{{ p.url | relative_url }}">{{ _titulo1 }}</a></h3>

            {%- if _actu_fmt != "" -%}
              <p class="sf-date">Actualizado: {{ _actu_fmt }}</p>
            {%- else -%}
              {%- assign _when_fallback = p.last_modified_at | default: p.date -%}
              <p class="sf-date">Actualizado: {{ _when_fallback | date: "%d/%m/%Y" }}</p>
            {%- endif -%}

            {%- assign _autor = site.data.autor.autores[p.autor] -%}
            {%- if _autor -%}
              <p class="sf-by">
                <img src="{{ _autor.avatar }}" alt="{{ _autor.nombre }}" class="sf-avatar">
                <a href="{{ _autor.enlaceBlog | default: '#' }}">{{ _autor.nombre }}</a>
              </p>
            {%- endif -%}
          </div>
        </article>
        {%- endfor -%}
      </div>
    </div>

    {%- comment -%} FECHA principal con el mismo formato {%- endcomment -%}
    {%- assign _tipo_main = main.tipo | downcase -%}
    {%- assign _productos_data_main = site.data[_tipo_main].productos -%}
    {%- assign _cabeceraTitulo = site.data[_tipo_main].cabecera.titulo -%}
    {%- assign _actu_val_main = _productos_data_main.actualizacion | default: "" -%}
    {%- assign _actu_fmt_main = "" -%}
    {%- if _actu_val_main != "" -%}
      {%- if _actu_val_main contains "-" or _actu_val_main contains ":" or _actu_val_main contains "T" -%}
        {%- assign _actu_fmt_main = _actu_val_main | date: "%d/%m/%Y" -%}
      {%- elsif _actu_val_main contains "/" -%}
        {%- assign _actu_fmt_main = _actu_val_main -%}
      {%- else -%}
        {%- assign _actu_fmt_main = _actu_val_main | date: "%d/%m/%Y" -%}
      {%- endif -%}
    {%- endif -%}

    <h3 class="sf-main-title"><a href="{{ main.url | relative_url }}">{{ _cabeceraTitulo }}</a></h3>

    {%- if _actu_fmt_main != "" -%}
      <p class="sf-date">Actualizado: {{ _actu_fmt_main }}</p>
    {%- else -%}
      {%- assign _when_main_fallback = main.last_modified_at | default: main.date -%}
      <p class="sf-date">Actualizado: {{ _when_main_fallback | date: "%d/%m/%Y" }}</p>
    {%- endif -%}

    {%- assign _autor_main = site.data.autor.autores[main.autor] -%}
    {%- if _autor_main -%}
      <p class="sf-by">
        <img src="{{ _autor_main.avatar }}" alt="{{ _autor_main.nombre }}" class="sf-avatar">
        <a href="{{ _autor_main.enlaceBlog | default: '#' }}">{{ _autor_main.nombre }}</a>
      </p>
    {%- endif -%}
    <p class="sf-dek">
      {%- if main.subtitle -%}{{ main.subtitle }}{%- else -%}{{ main.excerpt | strip_html | truncate: 180 }}{%- endif -%}
    </p>
  {%- endif -%}
</section>

<style>
.split-feature{max-width:1200px;margin:0px auto 36px;padding:0px 14px;}
.sf-head{display:flex;align-items:flex-end;justify-content:space-between;}
.sf-title{margin:0;font-size:1.6rem;font-weight:900;}
.sf-links a{color:#111 !important;font-size:1.2rem !important;white-space:nowrap;text-decoration:none;font-weight:bold !important;}
.sf-links a:hover{color:#0073e6 !important;text-decoration:none}
.sf-hero{display:grid;grid-template-columns:1fr 1fr;gap:20px;align-items:stretch;}
.sf-media img{width:100%;height:100%;aspect-ratio:16/9;object-fit:cover;display:block;border-radius:10px;}
.sf-side{display:grid;grid-template-rows:repeat(3,1fr);gap:16px;height:100%;}
.sf-item{display:grid;grid-template-columns:140px 1fr;gap:12px;height:100%;overflow:hidden;}
.sf-thumb img{width:140px;height:100%;object-fit:cover;display:block;border-radius:10px;}
.sf-body{display:flex;flex-direction:column;gap:6px;min-width:0;}
.sf-main-title{margin:10px 0 6px;font-size:1.2rem;font-weight:800;line-height:1.2;}
.sf-main-title a{color:#111 !important;text-decoration:none;font-weight:bold !important;}
.sf-main-title a:hover{color:#0073e6 !important;text-decoration:none;font-weight:bold !important;}
.sf-item-title{margin:0;font-size:1.2rem;font-weight:800;line-height:1.2;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;}
.sf-item-title a{color:#111 !important;text-decoration:none;font-weight:bold !important;}
.sf-item-title a:hover{color:#0073e6 !important;text-decoration:none;font-weight:bold !important;}
.sf-date{margin:6px 0 6px;color:#0073e6;font-size:.84rem;font-weight:700;}
.sf-by{color:#111 !important;margin:0;display:inline-flex;align-items:center;gap:8px;color:#555;font-size:.9rem;}
.sf-by .sf-avatar{width:24px;height:24px;border-radius:50%;object-fit:cover;display:inline-block;}
.sf-dek{margin:8px 0 0;color:#444;line-height:1.5;}
.sf-desc{margin:0 0 20px;color:#666;}
@media (max-width: 900px){
  .sf-hero{grid-template-columns:1fr;gap:16px;}
  .sf-side{grid-template-rows:none;display:flex;flex-direction:column;}
  .sf-item{grid-template-columns:110px 1fr;height:auto;}
  .sf-thumb img{width:110px;height:80px;}
}
/* === OVERRIDES AUTOR: alineado correcto y colores consistentes === */
.split-feature .sf-body{min-width:0;}

.split-feature .sf-side .sf-body{
  display:grid; grid-template-rows:auto auto auto; row-gap:6px; align-content:start;
}
.split-feature .sf-by{
  display:inline-flex !important; align-items:center; justify-content:flex-start; gap:8px; margin:0; line-height:1;
}
.split-feature .sf-by .sf-avatar{
  width:22px; height:22px; border-radius:50%; object-fit:cover; flex:0 0 22px; display:inline-block;
}
.split-feature .sf-by a, .split-feature .sf-by a:visited{
  color:#111 !important; text-decoration:none; margin:0 !important; padding:0 !important; font-size:.95rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:100%;
}
.split-feature .sf-by a:hover{ color:#0073e6 !important; }
.split-feature .sf-by a{ margin-left:0 !important; }

.split-feature .sf-side .sf-body{
  display:grid !important; grid-template-rows:auto auto auto; row-gap:6px; align-content:start; justify-items:start;
}
.split-feature .sf-by{
  display:inline-flex !important; align-items:center !important; justify-content:flex-start !important; gap:8px !important; margin:0 !important; line-height:1 !important; width:auto !important;
}
.split-feature .sf-by .sf-avatar{
  width:22px !important; height:22px !important; border-radius:50% !important; object-fit:cover !important; flex:0 0 22px !important;
}
.split-feature .sf-by a, .split-feature .sf-by a:visited{
  display:inline-block !important; margin:0 !important; padding:0 !important; float:none !important; text-align:left !important; color:#111 !important; font-size:.95rem !important; white-space:nowrap !important; overflow:hidden !important; text-overflow:ellipsis !important; max-width:100% !important;
}
.split-feature .sf-by a:hover{ color:#0073e6 !important; }
.split-feature .sf-side .sf-item{ align-items:start !important; }

.split-feature{ --sf-thumb: 120px; }
@media (max-width: 900px){
  .split-feature{ --sf-thumb: 100px; }
}
.split-feature .sf-side{ grid-template-rows: repeat(3, auto) !important; height:auto !important; }
.split-feature .sf-side .sf-item{ grid-template-columns: var(--sf-thumb) 1fr !important; align-items:start !important; height:auto !important; }
.split-feature .sf-side .sf-thumb{ width: var(--sf-thumb) !important; height: var(--sf-thumb) !important; display:block !important; }
.split-feature .sf-side .sf-thumb img{ width:100% !important; height:100% !important; aspect-ratio:1 / 1 !important; object-fit:cover !important; border-radius:10px !important; }
.split-feature .sf-side .sf-thumb img, .split-feature .sf-side .sf-item{ overflow:hidden; }

.split-feature .sf-date{ margin:6px 0 6px; color:#0073e6; font-size:14px; font-weight:700; }
</style>
