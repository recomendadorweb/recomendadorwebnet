<style>
  #menu-float-button {
    position: fixed;
    top: 1rem;
    left: 1rem;
    z-index: 1100;
    background-color: #222;
    color: white;
    padding: 0.5rem 0.8rem;
    font-size: 1.4rem;
    border-radius: 8px;
    cursor: pointer;
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    transition: opacity 0.2s ease;
  }
  #menu-float-button.hidden { opacity: 0; pointer-events: none; }
  @media (min-width: 768px) { #menu-float-button { display: none; } }
  @media (max-width: 767px) { .nav-container { display: none !important; } }
</style>

<nav class="main-nav">
  <div id="menu-float-button">‚ò∞</div>
  <div class="nav-container" style="padding: 0.4em 0.4em; display: flex; justify-content: space-between; align-items: center;">
    <!-- Enlace Blog (se respeta) -->
    <div class="nav-left nav-links">
      <a href="/" style="color: white; text-decoration: none; font-weight: 500;">üìù Blog</a>
    </div>

    <!-- Gu√≠as de compra -->
    <div class="nav-right" style="display: flex; align-items: center; gap: 1.2em;">
      <ul class="nav-links" style="margin: 0;">
        <li class="menu-label" style="display: flex; align-items: center; color: #ccc; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; padding-top: 0.15em;">
          üõí GU√çAS DE COMPRA >
        </li>

        {%- comment -%} Construimos categor√≠as (soporta categoria como string o array) {%- endcomment -%}
        {%- assign paginas = site.html_pages | where_exp: "p", "p.categoria" -%}
        {%- assign cats_concat = "" -%}
        {%- for p in paginas -%}
          {%- assign cat = p.categoria -%}
          {%- if cat.first -%}
            {%- for c in cat -%}
              {%- assign cats_concat = cats_concat | append: c | append: "||" -%}
            {%- endfor -%}
          {%- else -%}
            {%- assign cats_concat = cats_concat | append: cat | append: "||" -%}
          {%- endif -%}
        {%- endfor -%}
        {%- assign categorias = cats_concat | split: "||" | uniq | sort -%}

        {%- for cat in categorias -%}
          {%- assign cat_clean = cat | strip -%}
          {%- if cat_clean == "" -%}{% continue %}{%- endif -%}

          {%- comment -%} P√°ginas de la categor√≠a (string o array) {%- endcomment -%}
          {%- assign paginas_cat = paginas | where: "categoria", cat_clean -%}
          {%- if paginas_cat.size == 0 -%}
            {%- assign paginas_cat = paginas | where_exp: "p", "p.categoria and p.categoria contains cat_clean" -%}
          {%- endif -%}
          {%- assign items = paginas_cat | sort: "title" -%}

          {%- comment -%}
            Buscar emoji en site.data.categorias_meta.yml
            1) Intento directo por clave: categorias_meta[cat_clean]
            2) Fallback: recorrer items y comparar campo 'padre' con cat_clean
          {%- endcomment -%}
          {%- assign emoji = "" -%}
          {%- assign meta_direct = site.data.categorias_meta[cat_clean] -%}
          {%- if meta_direct and meta_direct.emoji -%}
            {%- assign emoji = meta_direct.emoji -%}
          {%- else -%}
            {%- for kv in site.data.categorias_meta -%}
              {%- assign meta_val = kv[1] -%}
              {%- if meta_val.padre and meta_val.padre == cat_clean and meta_val.emoji -%}
                {%- assign emoji = meta_val.emoji -%}
                {%- break -%}
              {%- endif -%}
            {%- endfor -%}
          {%- endif -%}

          <li class="dropdown">
          {%- assign cat_slug = cat_clean | slugify: 'latin' -%}
          <a href="{{ '/categorias/' | append: cat_slug | relative_url }}">{% if emoji != "" %} {{ emoji }}{% endif %} {{ cat_clean | capitalize }}</a>
            <ul class="submenu">
              {%- for page in items -%}
                {%- if page.tipo and site.data[page.tipo] and site.data[page.tipo].cabecera and site.data[page.tipo].cabecera.menu -%}
                  {%- assign texto_menu = site.data[page.tipo].cabecera.menu -%}
                {%- else -%}
                  {%- assign texto_menu = page.title | default: page.url -%}
                {%- endif -%}
                <li><a href="{{ page.url | relative_url }}">{{ texto_menu }}</a></li>
              {%- endfor -%}
            </ul>
          </li>
        {%- endfor -%}

        <!-- Enlaces est√°ticos -->
      </ul>
    </div>
  </div>
</nav>

<!-- Men√∫ m√≥vil -->
<div id="overlay" class="overlay" style="display: none;"></div>
<nav id="mobile-menu" class="menu" style="left: -100%;">
  <div class="mobile-header" style="border-bottom: 1px solid #ddd; padding-bottom: 0.5rem; background-color: #ffffff; position: sticky; top: 0; z-index: 10;">
    <h2>üìÇ Recomendador.net</h2>
    <button id="menu-close" class="close">&times;</button>
  </div>
  <ul>
    <li><a href="/">üìù Blog</a></li>

    {%- comment -%} Mismo enfoque robusto para m√≥vil {%- endcomment -%}
    {%- assign paginas_m = site.html_pages | where_exp: "p", "p.categoria" -%}
    {%- assign cats_concat_m = "" -%}
    {%- for p in paginas_m -%}
      {%- assign cat = p.categoria -%}
      {%- if cat.first -%}
        {%- for c in cat -%}
          {%- assign cats_concat_m = cats_concat_m | append: c | append: "||" -%}
        {%- endfor -%}
      {%- else -%}
        {%- assign cats_concat_m = cats_concat_m | append: cat | append: "||" -%}
      {%- endif -%}
    {%- endfor -%}
    {%- assign categorias_m = cats_concat_m | split: "||" | uniq | sort -%}

    {%- for cat in categorias_m -%}
      {%- assign cat_clean = cat | strip -%}
      {%- if cat_clean == "" -%}{% continue %}{%- endif -%}

      {%- assign paginas_cat = paginas_m | where: "categoria", cat_clean -%}
      {%- if paginas_cat.size == 0 -%}
        {%- assign paginas_cat = paginas_m | where_exp: "p", "p.categoria and p.categoria contains cat_clean" -%}
      {%- endif -%}
      {%- assign items = paginas_cat | sort: "title" -%}

      {%- assign emoji = "" -%}
      {%- assign meta_direct = site.data.categorias_meta[cat_clean] -%}
      {%- if meta_direct and meta_direct.emoji -%}
        {%- assign emoji = meta_direct.emoji -%}
      {%- else -%}
        {%- for kv in site.data.categorias_meta -%}
          {%- assign meta_val = kv[1] -%}
          {%- if meta_val.padre and meta_val.padre == cat_clean and meta_val.emoji -%}
            {%- assign emoji = meta_val.emoji -%}
            {%- break -%}
          {%- endif -%}
        {%- endfor -%}
      {%- endif -%}

      <li>
      {%- assign cat_slug = cat_clean | slugify: 'latin' -%}
      <a href="{{ '/categorias/' | append: cat_slug | relative_url }}">{% if emoji != "" %} {{ emoji }}{% endif %} {{ cat_clean | capitalize }}</a>
        <ul>
          {%- for page in items -%}
            {%- if page.tipo and site.data[page.tipo] and site.data[page.tipo].cabecera and site.data[page.tipo].cabecera.menu -%}
              {%- assign texto_menu = site.data[page.tipo].cabecera.menu -%}
            {%- else -%}
              {%- assign texto_menu = page.title | default: page.url -%}
            {%- endif -%}
            <li><a href="{{ page.url | relative_url }}">{{ texto_menu }}</a></li>
          {%- endfor -%}
        </ul>
      </li>
    {%- endfor -%}

    <li style="margin-bottom: 20px;"><a href="/contacto/">üì¨ ¬°Contacta con nosotros!</a></li>
  </ul>
</nav>

<style>
  .menu {
    border-top-right-radius: 12px; border-bottom-right-radius: 12px;
    position: fixed; top: 0; left: -100%;
    width: 80%; height: 100%;
    background: linear-gradient(180deg, #ece9f1 0%, #ffffff 100%);
    box-shadow: 2px 0 5px rgba(0,0,0,0.3);
    overflow-y: auto; transition: left 0.3s ease;
    z-index: 1000; padding: 1rem;
    font-family: 'Poppins', sans-serif; font-size: 16px; line-height: 1.6;
  }
  .menu.show { left: 0 !important; }
  .overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 999; }
  .overlay.show { display: block !important; }
  .mobile-header { display: flex; justify-content: space-between; align-items: center; min-height: 20px; padding: 0.5rem; }
  .mobile-header h2 { font-size: 1.2rem; margin: 0; color: #222; }
  .close {
    font-size: 2.4rem; font-weight: bold; width: 2.2rem; height: 2.2rem; line-height: 2.4rem;
    background: #ffecec; border: 2px solid #ff4c4c; border-radius: 50%; cursor: pointer;
    color: #ff4c4c; display: flex; align-items: center; justify-content: center;
    transition: all 0.2s ease; box-shadow: 0 2px 6px rgba(0,0,0,0.2);
  }
  .close:hover { background: #ff4c4c; color: white; }
  #mobile-menu ul { list-style: none; padding: 0; margin: 0; }
  #mobile-menu ul > li { padding: 0.5rem 0; border-bottom: 1px solid #eee; }
  #mobile-menu ul > li > a { font-weight: bold; font-size: 1rem; color: #222; text-decoration: none; }
  #mobile-menu ul li ul { margin-left: 1rem; padding-left: 1rem; background-color: #fdfdfd; margin-top: 0.3rem; border-left: 2px solid #ddd; }
  #mobile-menu ul li ul li a { color: #555; font-weight: normal; display: block; padding: 0.3rem 0; text-decoration: none; }
</style>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const toggle = document.getElementById("menu-float-button");
    const menu = document.getElementById("mobile-menu");
    const close = document.getElementById("menu-close");
    const overlay = document.getElementById("overlay");

    if (toggle && menu && close && overlay) {
      toggle.onclick = () => {
        menu.classList.add("show");
        overlay.classList.add("show");
        document.body.classList.add("menu-abierto");
        toggle.classList.add("hidden");
      };
      const cerrarMenu = () => {
        menu.classList.remove("show");
        overlay.classList.remove("show");
        document.body.classList.remove("menu-abierto");
        toggle.classList.remove("hidden");
      };
      close.onclick = cerrarMenu;
      overlay.onclick = cerrarMenu;
    }
  });
</script>
