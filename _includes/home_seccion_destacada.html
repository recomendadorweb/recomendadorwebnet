<style>
.home-card .card-meta{margin-top:.5rem;font-size:1rem;color:#666;display:flex;align-items:center;gap:6px;flex-wrap:wrap;margin:6px 10px 10px 10px;}
.home-card .author-inline{display:inline-flex;align-items:center;gap:.4rem;text-decoration:none;color:inherit}
.home-card .author-inline:hover{text-decoration:underline}
.home-card .author-avatar-xs{width:20px;height:20px;border-radius:9999px;object-fit:cover;flex:none}
.home-card .sep{opacity:.5}

/* Cabecera de sección: H2 + enlace a la derecha */
.home-section .section-head{display:flex;align-items:baseline;justify-content:space-between;gap:.5rem}
.home-section .section-head .see-all{font-size:1rem;white-space:nowrap;text-decoration:none}
.home-section .section-head .see-all:hover{text-decoration:underline}

/* (opcional) margen homogéneo del H2 */
.home-section .section-head h2{margin:.2rem 0;}
.home-section a {
  color: #000 !important;
  text-decoration: none;
  font-weight: bold !important;
  font-size: 1.2rem !important;
}

/* Enlaces al hacer hover en azul */
.home-section a:hover {
  color: #0073e6 !important;
  font-weight: bold !important;
}
.home-section .author-name-xs {
  font-size: 0.95rem;
  font-weight: normal !important;
}
.home-section .author-inline:hover .author-name-xs {
  color: #0073e6;
}

/* Descripción opcional bajo el título */
.home-card .card-desc{
  margin: 0px 10px;
  font-size: .9rem;
  line-height: 1.4;
  color: #444;
}

/* Meta de la tarjeta */
.card-meta {
  display: flex;
  align-items: center;
  gap: 6px;
  flex-wrap: wrap;
}

/* “Actualizado” en negrita y azul */
.card-meta .updated-inline {
  font-weight: bold;
  color: #0073e6; /* azul */
  font-size: 14px;
}

/* Bloque autor a la derecha */
.card-meta .author-block {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  margin-left: auto; /* Se empuja a la derecha */
}

/* “por” más discreto */
.card-meta .author-block .by-label {
  font-size: 0.95rem;
  color: #666;
}
/* Aplica el estilo de 'Actualizado' en cualquier posición */
.home-card .updated-inline {
  font-weight: bold;
  color: #0073e6; /* azul */
  font-size: 14px;
}

/* Cuando 'Actualizado' va encima del texto, dale el mismo margen que la descripción */
.home-card .updated-above {
  display: block;
  margin: 0 10px .25rem 10px;
}

/* La tarjeta reparte su contenido en columna */
.home-card{
  display: flex;
  flex-direction: column;
  height: 100%;
}

/* Título y texto: no crecen, sólo ocupan su contenido */
.home-card h3,
.home-card .card-desc,
.home-card .updated-above{
  flex: 0 0 auto;
}

/* Meta (fecha + autor) pegada al fondo SIEMPRE */
.home-card .card-meta{
  margin-top: auto;              /* empuja hacia abajo */
  padding: 0 10px 10px 10px;     /* ajuste opcional */
}

/* Autor a la derecha dentro de la meta */
.home-card .card-meta .author-block{
  margin-left: auto;
}

/* (Opcional, para uniformar la altura de imágenes) */
.home-card .card-image img{
  width: 100%;
  aspect-ratio: 16 / 9;          /* todas con la misma “caja” */
  object-fit: cover;
  display: block;
}
/* Tarjeta en columna y meta al fondo */
.home-card{
  display: flex;
  flex-direction: column;
  height: 100%;
  flex: 1 1 0;        /* todas comparten ancho y se encogen si hace falta */
  min-width: 0;       /* evita desbordes por contenido largo */
}
.home-card .card-meta{
  margin-top: auto;      /* baja el bloque autor */
  padding: 0 10px 10px;
  display: flex;
}
.home-card .author-block{ margin-left: auto; }

/* Fecha bajo el título */
.home-card .under-title{
  display: block;
  margin: 4px 10px 6px 10px;
}

/* Imágenes uniformes (opcional) */
.home-card .card-image img{
  width: 100%;
  aspect-ratio: 16/9;
  object-fit: cover;
  display: block;
}
/* Forzar 4 columnas (o las que pases en --cols) en una sola fila */
.home-section .home-grid{
  display: grid;
  grid-template-columns: repeat(var(--cols, 4), minmax(0, 1fr)) !important;
  gap: 20px;
  align-items: stretch;
}

/* Evita que el contenido fuerce ancho mínimo */
.home-section .home-grid > .home-card{ min-width: 0; }
.home-section .home-card h3,
.home-section .home-card .card-desc{ min-width: 0; overflow-wrap: anywhere; }

/* Asegura el meta al fondo y alinea verticalmente el autor */
.home-card{
  display: flex;
  flex-direction: column;
  height: 100%;
}

.home-card .card-meta{
  margin-top: auto;           /* pega al fondo */
  padding: 0 10px 10px;
  display: flex;
  align-items: center;        /* centra avatar+nombre en su fila */
  min-height: 28px;           /* asegura una línea constante */
}

.home-card .author-block{
  margin-left: auto;
  display: inline-flex;
  align-items: center;
  gap: 4px;
}

/* Evita saltos de línea y “bailes” por nombres largos */
.home-card .author-name-xs{
  line-height: 1;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 140px;           /* ajusta si quieres más ancho */
}
/* ===== Mobile overrides (solo móviles) ===== */
@media (max-width: 640px) {
  /* 1 tarjeta por fila */
  .home-section .home-grid{
    grid-template-columns: 1fr !important; /* ignora --cols en inline */
    gap: 2px;
  }

  /* Ajustes suaves de tipografía/espacios en móvil */
  .home-section .section-head{ align-items: center; }
  .home-section .section-head .see-all{ font-size: .95rem; }

  .home-section a{ font-size: 1.05rem !important; }
  .home-card h3{ font-size: 1.05rem; }

  .home-card .card-meta{
    padding: 0 8px 0px;
    min-height: 28px;
  }

  .home-card .author-name-xs{
    max-width: 120px; /* evita cortes raros en nombres largos */
  }

  /* Mantén imágenes consistentes */
  .home-card .card-image img{
    aspect-ratio: 16/9;
    object-fit: cover;
  }
}

</style>

<div class="hero-divider"></div>
<section class="homepage-home" aria-label="Home upgrades">
  <div class="home-section">

{%- capture see_all_url -%}
  {{ include.see_all_url | default: include.enlace_see_all | default: include.enlace_categoria }}
{%- endcapture -%}
{%- assign see_all_url = see_all_url | strip -%}

<div class="section-head">
  <h2>{{ include.h2 | default: "Hogar" }}</h2>
  {%- unless see_all_url == "" or see_all_url == "true" or see_all_url == "false" -%}
    <a class="see-all" href="{{ see_all_url }}"
       aria-label="Ver todas las guías de {{ include.h2 | default: 'esta categoría' }}">
       Ver todo en {{ include.h2 | default: 'esta categoría' }}
    </a>
  {%- endunless -%}
</div>

    <p>{{ include.descripcion | default: "Productos probados por Recomendador.net para mejorar tu hogar." }}</p>

    {% assign limite = include.limite | default: 4 | plus: 0 %}

    {%- comment -%}
      Normaliza y admite múltiples carpetas (coma-separadas) e incluye todas sus subcarpetas.
      Ej.: carpeta="hogar,cocina/robotica,limpieza"
    {%- endcomment -%}
    {%- assign carpeta_param = include.carpeta | default: "" | strip
       | replace: ", ", "," | replace: " ,", "," -%}
    {%- assign carpetas = carpeta_param | split: "," -%}

    {%- comment -%} 1) Reunir candidatos {%- endcomment -%}
    {% assign html_pages = site.html_pages | where_exp: "p", "p.keywords != nil and p.date != nil" %}

    {%- if carpetas != empty and carpetas.first != "" -%}
      {% assign filtered_pages = "" | split: "" %}
      {% for f in carpetas %}
        {% assign f_norm = f | strip | replace: '//','/' | remove_first: '/' | remove: '/' %}
        {% assign needle = '/' | append: f_norm | append: '/' %}
        {% assign by_url  = html_pages | where_exp: "p", "p.url  contains needle" %}
        {% assign by_path = html_pages | where_exp: "p", "p.path contains needle" %}
        {% assign filtered_pages = filtered_pages | concat: by_url | concat: by_path %}
      {% endfor %}
      {% assign html_pages = filtered_pages | uniq %}
    {%- endif -%}

    {% assign coll_docs = "" | split: "" %}
    {% for coll in site.collections %}
      {% assign coll_docs = coll_docs | concat: coll.docs %}
    {% endfor %}
    {% assign html_docs = coll_docs | where_exp: "d", "d.extname == '.html' and d.keywords != nil and d.date != nil" %}

    {%- if carpetas != empty and carpetas.first != "" -%}
      {% assign filtered_docs = "" | split: "" %}
      {% for f in carpetas %}
        {% assign f_norm = f | strip | replace: '//','/' | remove_first: '/' | remove: '/' %}
        {% assign needle = '/' | append: f_norm | append: '/' %}
        {% assign by_url  = html_docs | where_exp: "d", "d.url  contains needle" %}
        {% assign by_path = html_docs | where_exp: "d", "d.path contains needle" %}
        {% assign filtered_docs = filtered_docs | concat: by_url | concat: by_path %}
      {% endfor %}
      {% assign html_docs = filtered_docs | uniq %}
    {%- endif -%}

    {% assign items = html_pages | concat: html_docs %}

    {%- comment -%}
      ==== FILTRO POR CATEGORÍA (front matter 'categoria' o 'categorias') ====
      Permite:
      - Param string simple: categorias="gaming"
      - Param múltiple con comas/pipes: categorias="gaming, tecnologia | hogar"
      - Param array desde front matter.
      Y cada item puede llevar `categoria: gaming, tecnologia` (string) o un array.
    {%- endcomment -%}
    {%- assign _cats_param_raw = include.categoria | default: include.categorias | default: "" -%}
    {%- assign cats_param_list = "" | split: "" -%}
    {%- if _cats_param_raw != "" -%}
      {%- assign tmp = _cats_param_raw -%}
      {%- unless tmp.first -%}
        {%- assign norm = _cats_param_raw
            | replace: ", ", "," | replace: " ,", ","
            | replace: " |", "|" | replace: "| ", "|"
          -%}
        {%- assign tmp = norm | split: "|" | join: "|" | split: "," | join: "|" | split: "|" -%}
      {%- endunless -%}
      {%- for c in tmp -%}
        {%- assign c_norm = c | downcase | strip -%}
        {%- if c_norm != "" -%}
          {%- assign cats_param_list = cats_param_list | push: c_norm -%}
        {%- endif -%}
      {%- endfor -%}
      {%- assign cats_param_list = cats_param_list | uniq -%}
    {%- endif -%}

    {%- if cats_param_list != empty -%}
      {%- assign items_by_cat = "" | split: "" -%}
      {%- for it in items -%}
        {%- assign has_cat = false -%}
        {%- assign it_cat_raw = it.categoria | default: it.categorias -%}
        {%- if it_cat_raw -%}
          {%- assign it_cats = it_cat_raw -%}
          {%- unless it_cats.first -%}
            {%- assign it_norm = it_cat_raw
                | replace: ", ", "," | replace: " ,", ","
                | replace: " |", "|" | replace: "| ", "|"
              -%}
            {%- assign it_cats = it_norm | split: "|" | join: "|" | split: "," | join: "|" | split: "|" -%}
          {%- endunless -%}
          {%- for pc in it_cats -%}
            {%- assign pc_norm = pc | downcase | strip -%}
            {%- if cats_param_list contains pc_norm -%}
              {%- assign has_cat = true -%}{% break %}{%- endif -%}
          {%- endfor -%}
        {%- endif -%}
        {%- if has_cat -%}
          {%- assign items_by_cat = items_by_cat | push: it -%}
        {%- endif -%}
      {%- endfor -%}
      {%- assign items = items_by_cat -%}
    {%- endif -%}

    {%- comment -%}
    2) Construir una lista ordenable con "YYYY-MM-DD|||<url>" para cada item,
       usando la fecha de _data/<tipo>/productos.yml -> productos.actualizacion.
    {%- endcomment -%}
    {% assign ordenables_str = "" %}
    {% for it in items %}
      {%- assign tipo_key = it.tipo -%}
      {%- assign data_grupo = site.data[tipo_key] -%}
      {%- if data_grupo == nil -%}
        {%- assign tipo_key = it.tipo | slugify: 'pretty' | downcase -%}
        {%- assign data_grupo = site.data[tipo_key] -%}
      {%- endif -%}
      {%- assign actualizado = nil -%}
      {%- if data_grupo and data_grupo.productos and data_grupo.productos.actualizacion -%}
        {%- assign actualizado = data_grupo.productos.actualizacion -%}
      {%- endif -%}
      {%- assign key = actualizado | default: "" -%}
      {%- if key != "" -%}
        {%- assign key = key | date: "%Y-%m-%d" -%}
      {%- else -%}
        {%- assign key = "0000-00-00" -%}
      {%- endif -%}
      {% capture ordenables_str %}{{ ordenables_str }}||SEP||{{ key }}|||{{ it.url }}{% endcapture %}
    {% endfor %}

    {% assign ordenables = ordenables_str | split: "||SEP||" | compact %}
    {% assign ordenables = ordenables | sort | reverse %}
    {% assign ordenables_lim = ordenables | slice: 0, limite %}

    <div class="home-grid" style="--cols: {{ limite }}">
      {%- comment -%} 3) Renderizar solo las X primeras tras ordenar {%- endcomment -%}
      {% for entry in ordenables_lim %}
        {% assign parts = entry | split: "|||" %}
        {% assign url = parts[1] %}
        {% assign item = items | where_exp: "i", "i.url == url" | first %}

        {%- comment -%} Recalcular autor y actualizado {%- endcomment -%}
        {%- assign tipo_key = item.tipo -%}
        {%- assign data_grupo = site.data[tipo_key] -%}
        {%- if data_grupo == nil -%}
          {%- assign tipo_key = item.tipo | slugify: 'pretty' | downcase -%}
          {%- assign data_grupo = site.data[tipo_key] -%}
        {%- endif -%}
        {%- assign actualizado = nil -%}
        {%- if data_grupo and data_grupo.productos and data_grupo.productos.actualizacion -%}
          {%- assign actualizado = data_grupo.productos.actualizacion -%}
        {%- endif -%}

        {%- assign autores = site.data.autor.autores -%}
        {%- assign autor_key = item.autor -%}
        {%- assign autor = autores[autor_key] -%}
        {%- if autor == nil and autor_key -%}
          {%- assign autor_key = autor_key | slugify: 'pretty' | downcase -%}
          {%- assign autor = autores[autor_key] -%}
        {%- endif -%}

        {%- comment -%}
          Normalizamos flags por si llegan como "true", "1" o "yes"
        {%- endcomment -%}
        {% assign desc_flag = include.descripcion_extra | default: '' | downcase %}
        {% assign autor_flag = include.mostrar_autor | default: '' | downcase %}

        {%- comment -%}
          Texto de descripción con fallback a otras claves comunes
        {%- endcomment -%}
        {% assign card_text = item.subtitle %}

        <article class="home-card">
          <a class="card-image" href="{{ item.url | relative_url }}">
            <img src="{{ item.imagenhome | default: item.imagen | default: '/global/images/placeholder.webp' }}" alt="{{ item.title | escape }}">
          </a>
<h3><a href="{{ item.url | relative_url }}">{{ data_grupo.cabecera.titulo }}</a></h3>

{%- comment -%} Fecha SIEMPRE bajo el título {%- endcomment -%}
{% if actualizado %}
  <small class="updated-inline under-title">
    Actualizado: {% include date_es.html date=actualizado %}
  </small>
{% endif %}

{%- comment -%} Descripción opcional {%- endcomment -%}
{% assign desc_flag = include.descripcion_extra | default: '' | downcase %}
{% assign show_desc = false %}
{% if item.subtitle and (include.descripcion_extra == true or desc_flag == 'true' or desc_flag == '1' or desc_flag == 'yes') %}
  {% assign show_desc = true %}
{% endif %}
{% if show_desc %}
  <p class="card-desc">{{ item.subtitle }}</p>
{% endif %}

<div class="card-meta">
  {%- comment -%} SOLO autor (a la derecha) {%- endcomment -%}
  {% assign autor_flag = include.mostrar_autor | default: '' | downcase %}
  {% if include.mostrar_autor == true or autor_flag == 'true' or autor_flag == '1' or autor_flag == 'yes' %}
    {% if autor %}
      <span class="author-block">
        <a class="author-inline" href "{{ autor.enlace | default: '#' }}">
          <img class="author-avatar-xs" src="{{ autor.avatar }}" alt="{{ autor.descripcion_alt | default: 'Avatar de ' | append: autor.nombre }}">
          <small class="author-name-xs">{{ autor.nombre }}</small>
        </a>
      </span>
    {% elsif item.autor %}
      <span class="author-block">
        <span class="author-inline"><small class="author-name-xs">{{ item.autor }}</small></span>
      </span>
    {% endif %}
  {% endif %}
</div>


        </article>
      {% endfor %}
    </div>
  </div>
</section>
