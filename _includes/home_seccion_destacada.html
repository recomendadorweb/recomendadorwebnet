<style>
.home-card .card-meta{margin-top:.5rem;font-size:1rem;color:#666;display:flex;align-items:center;gap:6px;flex-wrap:wrap;margin:6px 10px 10px 10px;}
.home-card .author-inline{display:inline-flex;align-items:center;gap:.4rem;text-decoration:none;color:inherit}
.home-card .author-inline:hover{text-decoration:underline}
.home-card .author-avatar-xs{width:20px;height:20px;border-radius:9999px;object-fit:cover;flex:none}
.home-card .sep{opacity:.5}

/* Cabecera de sección: H2 + enlace a la derecha */
.home-section .section-head{display:flex;align-items:baseline;justify-content:space-between;gap:.5rem}
.home-section .section-head .see-all{font-size:1rem;white-space:nowrap;text-decoration:none}
.home-section .section-head .see-all:hover{text-decoration:underline}

/* (opcional) margen homogéneo del H2 */
.home-section .section-head h2{margin:.2rem 0;}
.home-section a {
  color: #000 !important;
  text-decoration: none;
  font-weight: bold !important;
  font-size: 1.1rem !important;
}

/* Enlaces al hacer hover en azul */
.home-section a:hover {
  color: #0073e6 !important;
  font-weight: bold !important;
}
.home-section .author-name-xs {
  font-size: 0.95rem; /* aquí cambias el tamaño */
  font-weight: normal !important;
}
.home-section .author-inline:hover .author-name-xs {
  color: #0073e6;
}

/* Descripción opcional bajo el título */
.home-card .card-desc{
  margin: .35rem 10px 0 10px;
  font-size: .98rem;
  line-height: 1.4;
  color: #444;
}
</style>

<div class="hero-divider"></div>
<section class="homepage-home" aria-label="Home upgrades">
  <div class="home-section">

    {% assign enlace_see_all = include.enlace_categoria | default: include.ver_todo %}
    <div class="section-head">
      <h2>{{ include.h2 | default: "Hogar" }}</h2>
      {% if enlace_see_all %}
        <a class="see-all" href="{{ enlace_see_all }}"
           aria-label="Ver todas las guías de {{ include.h2 | default: 'esta categoría' }}">Ver todo en {{ include.h2 | default: 'esta categoría' }}</a>
      {% endif %}
    </div>

    <p>{{ include.descripcion | default: "Productos probados por Recomendador.net para mejorar tu hogar." }}</p>

    {% assign folder = include.carpeta | default: "" %}
    {% assign limite = include.limite | default: 4 | plus: 0 %}

    {%- comment -%} 1) Reunir candidatos {%- endcomment -%}
    {% assign html_pages = site.html_pages | where_exp: "p", "p.keywords != nil and p.date != nil" %}
    {% if folder != "" %}
      {% assign html_pages = html_pages | where_exp: "p", "p.path contains include.carpeta or p.url contains include.carpeta" %}
    {% endif %}

    {% assign coll_docs = "" | split: "" %}
    {% for coll in site.collections %}
      {% assign coll_docs = coll_docs | concat: coll.docs %}
    {% endfor %}
    {% assign html_docs = coll_docs | where_exp: "d", "d.extname == '.html' and d.keywords != nil and d.date != nil" %}
    {% if folder != "" %}
      {% assign html_docs = html_docs | where_exp: "d", "d.path contains include.carpeta or d.url contains include.carpeta" %}
    {% endif %}

    {% assign items = html_pages | concat: html_docs %}

    {%- comment -%}
    2) Construir una lista ordenable con "YYYY-MM-DD|||<url>" para cada item,
       usando la fecha de _data/<tipo>/productos.yml -> productos.actualizacion.
       Si no existe, ponemos "0000-00-00" para que queden al final.
    {%- endcomment -%}
    {% assign ordenables_str = "" %}
    {% for it in items %}
      {%- assign tipo_key = it.tipo -%}
      {%- assign data_grupo = site.data[tipo_key] -%}
      {%- if data_grupo == nil -%}
        {%- assign tipo_key = it.tipo | slugify: 'pretty' | downcase -%}
        {%- assign data_grupo = site.data[tipo_key] -%}
      {%- endif -%}
      {%- assign actualizado = nil -%}
      {%- if data_grupo and data_grupo.productos and data_grupo.productos.actualizacion -%}
        {%- assign actualizado = data_grupo.productos.actualizacion -%}
      {%- endif -%}
      {%- assign key = actualizado | default: "" -%}
      {%- if key != "" -%}
        {%- assign key = key | date: "%Y-%m-%d" -%}
      {%- else -%}
        {%- assign key = "0000-00-00" -%}
      {%- endif -%}
      {% capture ordenables_str %}{{ ordenables_str }}||SEP||{{ key }}|||{{ it.url }}{% endcapture %}
    {% endfor %}

    {% assign ordenables = ordenables_str | split: "||SEP||" | compact %}
    {% assign ordenables = ordenables | sort | reverse %}
    {% assign ordenables_lim = ordenables | slice: 0, limite %}

    <div class="home-grid">
      {%- comment -%} 3) Renderizar solo las X primeras tras ordenar {%- endcomment -%}
      {% for entry in ordenables_lim %}
        {% assign parts = entry | split: "|||" %}
        {% assign url = parts[1] %}
        {% assign item = items | where_exp: "i", "i.url == url" | first %}

        {%- comment -%} Recalcular autor y actualizado para este item (tu lógica original) {%- endcomment -%}
        {%- assign tipo_key = item.tipo -%}
        {%- assign data_grupo = site.data[tipo_key] -%}
        {%- if data_grupo == nil -%}
          {%- assign tipo_key = item.tipo | slugify: 'pretty' | downcase -%}
          {%- assign data_grupo = site.data[tipo_key] -%}
        {%- endif -%}
        {%- assign actualizado = nil -%}
        {%- if data_grupo and data_grupo.productos and data_grupo.productos.actualizacion -%}
          {%- assign actualizado = data_grupo.productos.actualizacion -%}
        {%- endif -%}

        {%- assign autores = site.data.autor.autores -%}
        {%- assign autor_key = item.autor -%}
        {%- assign autor = autores[autor_key] -%}
        {%- if autor == nil and autor_key -%}
          {%- assign autor_key = autor_key | slugify: 'pretty' | downcase -%}
          {%- assign autor = autores[autor_key] -%}
        {%- endif -%}

        <article class="home-card">
          <a class="card-image" href="{{ item.url | relative_url }}">
            <img src="{{ item.image | default: item.imagen | default: '/global/images/placeholder.webp' }}" alt="{{ item.title | escape }}">
          </a>

          <h3><a href="{{ item.url | relative_url }}">{{ item.title }}</a></h3>

          {%- comment -%}
            NUEVO: Mostrar la descripción del front matter de la página
            si se llama al include con descripcion_extra=true
          {%- endcomment -%}


          <div class="card-meta">
            {% if actualizado %}
              <small class="updated-inline">
                Actualizado: {% include date_es.html date=actualizado %}
              </small>
            {% endif %}

            {% if autor %}
              <a class="author-inline" href="{{ autor.enlace | default: '#' }}">
                <img class="author-avatar-xs" src="{{ autor.avatar }}" alt="{{ autor.descripcion_alt | default: 'Avatar de ' | append: autor.nombre }}">
                <small class="author-name-xs">{{ autor.nombre }}</small>
              </a>
            {% endif %}
                                  
          </div>
          {% if include.descripcion_extra and item.text %}
            <p class="card-desc">{{ item.text }}</p>
          {% endif %}
        </article>
      {% endfor %}
    </div>
  </div>
</section>
