{% assign productos = site.data[tipo][include.datafile].productos %}
{% assign datos = site.data[tipo].cabecera %}

<style>
.separador-producto {
  border-top: 1px solid #838383;
  margin: 1.5em 0;
  opacity: 0.5;
}
.ficha-teclado img {
  position: relative;
  object-fit: contain;
}
.imagen-con-miniaturas {
  display: flex;
  justify-content: center;
  align-items: center; /* ✅ Alinea verticalmente al centro */
  gap: 1.5em;
  margin-bottom: 1em;
  flex-wrap: wrap;
}
.imagen-con-miniaturas .principal {
  max-height: 350px;
  width: auto;
}
.galeria-miniaturas {
  display: grid;
  grid-template-columns: repeat(2, 50px);
  grid-auto-rows: 50px;
  gap: 8px;
}
.galeria-miniaturas img {
  width: 50px;
  height: 50px;
  object-fit: cover;
  cursor: pointer;
  border: 1px solid #ccc;
  border-radius: 4px;
  transition: border 0.3s;
}
.galeria-miniaturas img:hover {
  border: 2px solid #0073e6;
}
.galeria-miniaturas img.activa {
  border: 2px solid #0073e6 !important;
}
@media (max-width: 768px) {
  .galeria-miniaturas {
    display: flex;
    flex-direction: row;
    gap: 8px;
    overflow-x: auto;
    padding-bottom: 10px;
    margin-top: 10px;
  }

  .galeria-miniaturas img {
    flex: 0 0 auto;
    width: 60px;
    height: 60px;
    object-fit: cover;
    border-radius: 4px;
  }
}

.lupa-amazon-container {
  display: flex;
  justify-content: center;
  gap: 1.5em;
  position: relative;
}

.lupa-imagen {
  position: relative;
}
.lupa-imagen img {
  display: block;
  max-height: 350px;
  cursor: zoom-in;
}
.zoom-flotante {
  position: absolute;
  width: 400px;
  height: 400px;
  border: 2px solid #0073e6;
  background-repeat: no-repeat;
  background-size: 300%;
  display: none;
  z-index: 9999;
  pointer-events: none;
  box-shadow: 0 0 10px rgba(0,0,0,0.3);
}

</style>

<script>
function mostrarZoomFlotante(container) {
  if (window.innerWidth < 768) return;
  const zoom = document.getElementById('zoom-flotante');
  const img = container.querySelector('img');
  const srcZoom = img.getAttribute('data-zoom') || img.src;
  zoom.style.display = 'block';
  zoom.style.backgroundImage = `url('${srcZoom}')`;
}

function ocultarZoomFlotante() {
  if (window.innerWidth < 768) return;
  const zoom = document.getElementById('zoom-flotante');
  zoom.style.display = 'none';
}

function moverZoomFlotante(e, container) {
  if (window.innerWidth < 768) return;
  const img = container.querySelector('img');
  const zoom = document.getElementById('zoom-flotante');
  const rect = img.getBoundingClientRect();

  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;

  const percentX = (x / rect.width) * 100;
  const percentY = (y / rect.height) * 100;

  zoom.style.backgroundPosition = `${percentX}% ${percentY}%`;

  // Posiciona el zoom junto al cursor
  zoom.style.left = `${e.pageX + 20}px`;
  zoom.style.top = `${e.pageY - 150}px`; // ajusta para centrar verticalmente
}


function seleccionarMiniatura(imgElement) {
  const nuevaSrc = imgElement.getAttribute("data-src");
  const contenedor = imgElement.closest(".ficha-teclado");
  const principal = contenedor.querySelector(".lupa-imagen img");

  principal.src = nuevaSrc;
  principal.setAttribute('data-zoom', nuevaSrc);

  const zoom = document.getElementById("zoom-flotante");
  zoom.style.backgroundImage = `url('${nuevaSrc}')`;

  const miniaturas = contenedor.querySelectorAll(".galeria-miniaturas img");
  miniaturas.forEach(img => img.classList.remove("activa"));
  imgElement.classList.add("activa");
}
</script>



<div id="zoom-flotante" class="zoom-flotante"></div>

<div class="bloque-productos">
  {% for producto in productos %}
    <div class="ficha-teclado">
      <h3 id="{{ producto.nombre }}">{{ producto.nombre }}</h3>

<div class="imagen-con-miniaturas">
<div class="lupa-imagen"
     onmousemove="moverZoomFlotante(event, this)"
     onmouseenter="mostrarZoomFlotante(this)"
     onmouseleave="ocultarZoomFlotante(this)">
  <a href="{{ producto.enlace }}" target="_blank" rel="nofollow sponsored">
    <img
      id="imagen-principal-{{ forloop.index }}"
      src="{{ producto.imagen }}"
      data-zoom="{{ producto.imagen }}"
      width="{{ producto.imagenWidth }}"
      height="{{ producto.imagenHeight }}"
      alt="{{ producto.nombre }}"
      loading="lazy"
    />
  </a>
</div>


  <div class="galeria-miniaturas">
    <!-- Imagen principal como miniatura -->
    <img
      src="{{ producto.imagen }}"
      data-src="{{ producto.imagen }}"
      class="activa"
      onclick="seleccionarMiniatura(this)"
      width="{{ producto.imagenWidth }}"
      height="{{ producto.imagenHeight }}"
      alt="Imagen principal de {{ producto.nombre }}"
      loading="lazy"
    />
    <!-- Variantes -->
    {% for variante in producto.imagenesVariantes %}
      <img
        src="{{ variante.url }}"
        data-src="{{ variante.url }}"
        onclick="seleccionarMiniatura(this)"
        width="{{ variante.width }}"
        height="{{ variante.height }}"
        alt="Variante de {{ producto.nombre }}"
        loading="lazy"
      />
    {% endfor %}
  </div>
</div>



    <p class="valoracion-html" style="font-weight: bold; color: #e67e22;">⭐ Valoración del experto: {{ producto.valoracion }}/5</p>
    {% if producto.precio %}
      <p class="precio-producto" style="margin-top: 6px;">
        <span style="color: #1a8917; font-weight: bold;">Precio actual:</span>
        <span class="precio-actual" style="font-size: 1.2em; font-weight: bold; color: #1a8917; margin-left: 5px;">
          {{ producto.precio }}
        </span>
        {% if producto.precioOriginal and producto.precioOriginal != "No especificado" %}
          <span class="precio-original" style="margin-left: 12px; font-size: 1.1em; font-weight: 600; color: #c0392b; text-decoration: line-through;">
            Antes: {{ producto.precioOriginal }}
          </span>
        {% endif %}
      </p>
    {% endif %}


      <p class="descripcion-review">{{ producto.descripcion | markdownify }}</p>

      {% if producto.caracteristicas %}
        <h4>Principales características:</h4>
        <ul class="bullets-review">
          {% for item in producto.caracteristicas %}
            <li>{{ item }}</li>
          {% endfor %}
        </ul>
      {% endif %}

        <a class="boton" href="{{ producto.enlace }}" style="min-height:44px" target="_blank" rel="nofollow sponsored">{{ datos.emoji }} Ver oferta actual en Amazon</a>
    </div>

    {% unless forloop.last %}
      <div class="separador-producto"></div>
    {% endunless %}
  {% endfor %}
</div>
