{% assign productos = site.data[tipo][include.datafile].productos %}
{% assign datos = site.data[tipo].cabecera %}

<style>
.separador-producto {
  border-top: 1px solid #838383;
  margin: 1.5em 0;
  opacity: 0.5;
}
.ficha-teclado img { position: relative; object-fit: contain; }
.imagen-con-miniaturas {
  display: flex; justify-content: center; align-items: center; gap: 1.5em;
  margin-bottom: 1em; flex-wrap: wrap;
}
.imagen-con-miniaturas .principal { max-height: 350px; width: auto; }
.galeria-miniaturas {
  display: grid; grid-auto-flow: column; grid-template-rows: repeat(5, 50px); gap: 8px;
}
.galeria-miniaturas img {
  width: 50px; height: 50px; object-fit: cover; cursor: pointer;
  border: 1px solid #ccc; border-radius: 4px; transition: border 0.3s;
}
.galeria-miniaturas img:hover { border: 2px solid #0073e6; }
.galeria-miniaturas img.activa { border: 2px solid #0073e6 !important; }

@media (max-width: 768px) {
  .galeria-miniaturas {
    display: flex; flex-direction: row; gap: 8px; overflow-x: auto;
    padding-bottom: 10px; margin-top: 10px; scroll-snap-type: x mandatory;
  }
  .galeria-miniaturas img { flex: 0 0 auto; width: 60px; height: 60px; object-fit: cover; border-radius: 4px; scroll-snap-align: start; }
}

/* Lupa/zoom por producto (no global) */
.lupa-amazon-container { display: flex; justify-content: center; gap: 1.5em; position: relative; }
.lupa-imagen { position: relative; }
.lupa-imagen img { display: block; max-height: 350px; cursor: zoom-in; }
.zoom-flotante {
  position: absolute; width: 400px; height: 400px; border: 2px solid #0073e6;
  background-repeat: no-repeat; background-size: 300%; display: none;
  z-index: 9999; pointer-events: none; box-shadow: 0 0 10px rgba(0,0,0,0.3);
}

/* Selector de variantes */
.selector-variantes {
  display: flex; gap: .5rem; flex-wrap: wrap; align-items: center; margin: .5rem 0 1rem;
}
.selector-variantes .var-btn {
  display: inline-flex; align-items: center; gap: .5rem;
  border: 1px solid #ccc; border-radius: 8px; padding: .35rem .6rem;
  cursor: pointer; background: #fff; font-size: .9rem;
}
.selector-variantes .var-btn[aria-pressed="true"] { border-color: #0073e6; box-shadow: 0 0 0 2px rgba(0,115,230,.15); }
.selector-variantes .var-btn img { width: 28px; height: 28px; object-fit: cover; border-radius: 4px; }
.selector-variantes .var-label { white-space: nowrap; max-width: 180px; overflow: hidden; text-overflow: ellipsis; }
</style>

<script>
/* === LUPA / ZOOM por producto === */
function mostrarZoomFlotante(container) {
  if (window.innerWidth < 768) return;
  const zoom = container.closest('.ficha-teclado').querySelector('.zoom-flotante');
  const img = container.querySelector('img');
  const srcZoom = img.getAttribute('data-zoom') || img.src;
  zoom.style.display = 'block';
  zoom.style.backgroundImage = `url('${srcZoom}')`;
}
function ocultarZoomFlotante(container) {
  if (window.innerWidth < 768) return;
  const zoom = container.closest('.ficha-teclado').querySelector('.zoom-flotante');
  zoom.style.display = 'none';
}
function moverZoomFlotante(e, container) {
  if (window.innerWidth < 768) return;
  const img = container.querySelector('img');
  const zoom = container.closest('.ficha-teclado').querySelector('.zoom-flotante');
  const rect = img.getBoundingClientRect();

  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;
  zoom.style.backgroundPosition = `${(x/rect.width)*100}% ${(y/rect.height)*100}%`;

  zoom.style.left = `${e.pageX + 20}px`;
  zoom.style.top = `${e.pageY - 150}px`;
}

/* === MINIATURAS === */
function seleccionarMiniatura(imgElement) {
  const nuevaSrc = imgElement.getAttribute("data-src");
  const contenedor = imgElement.closest(".ficha-teclado");
  const principal = contenedor.querySelector(".lupa-imagen img");

  principal.src = nuevaSrc;
  principal.setAttribute('data-zoom', nuevaSrc);

  const zoom = contenedor.querySelector(".zoom-flotante");
  zoom.style.backgroundImage = `url('${nuevaSrc}')`;

  const miniaturas = contenedor.querySelectorAll(".galeria-miniaturas img");
  miniaturas.forEach(img => img.classList.remove("activa"));
  imgElement.classList.add("activa");
}

/* === VARIANTES === */
function onVariantClick(btn) {
  const ficha = btn.closest('.ficha-teclado');
  ficha.querySelectorAll('.selector-variantes .var-btn').forEach(b=>b.setAttribute('aria-pressed','false'));
  btn.setAttribute('aria-pressed','true');

  const vImg = btn.dataset.imagen;
  const vEnlace = btn.dataset.enlace;
  const vPrecio = btn.dataset.precio || '';
  const vPrecioOriginal = btn.dataset.precioOriginal || '';

  // 1) imagen principal + zoom
  const principal = ficha.querySelector('.lupa-imagen img');
  if (vImg) {
    principal.src = vImg;
    principal.setAttribute('data-zoom', vImg);
  }

  // 2) ENLACES: botón de compra + enlace de la imagen principal
  const boton = ficha.querySelector('.boton-compra');
  if (boton && vEnlace) boton.href = vEnlace;

  const linkImg = ficha.querySelector('.lupa-imagen a');
  if (linkImg && vEnlace) linkImg.href = vEnlace;

  // 3) precios
  const precioActual = ficha.querySelector('.precio-actual');
  if (precioActual) precioActual.textContent = vPrecio || '';

  const precioOriginal = ficha.querySelector('.precio-original');
  if (precioOriginal) {
    if (vPrecioOriginal && vPrecioOriginal !== 'No especificado') {
      precioOriginal.style.display = '';
      precioOriginal.textContent = `Antes: ${vPrecioOriginal}`;
    } else {
      precioOriginal.style.display = 'none';
    }
  }

  // 4) galería de miniaturas
  const galeria = ficha.querySelector('.galeria-miniaturas');
  const imagenesJson = btn.dataset.imagenes || '';
  if (galeria && imagenesJson) {
    try {
      const imagenes = JSON.parse(imagenesJson);
      galeria.innerHTML = '';
      const mini = document.createElement('img');
      mini.src = vImg;
      mini.setAttribute('data-src', vImg);
      mini.className = 'activa';
      mini.alt = 'Imagen principal';
      mini.loading = 'lazy';
      mini.onclick = function(){ seleccionarMiniatura(this); };
      galeria.appendChild(mini);

      imagenes.forEach(iv=>{
        const m = document.createElement('img');
        m.src = iv.url;
        m.setAttribute('data-src', iv.url);
        m.alt = 'Variante';
        m.loading = 'lazy';
        m.onclick = function(){ seleccionarMiniatura(this); };
        galeria.appendChild(m);
      });
    } catch(e) { /* silencio intencional */ }
  }
}

/* Accesibilidad con teclado en variantes */
document.addEventListener('keydown', function(e){
  if (e.key !== 'Enter' && e.key !== ' ') return;
  const tgt = e.target;
  if (tgt.classList && tgt.classList.contains('var-btn')) {
    e.preventDefault();
    onVariantClick(tgt);
  }
});
</script>

<div class="bloque-productos">
  {% for producto in productos %}
    <article class="ficha-teclado">
      <h3 id="{{ producto.nombre }}">{{ producto.nombre }}</h3>

      {%- assign tiene_variantes = producto.variantes | size | default: 0 -%}
      {%- if tiene_variantes > 0 -%}

      {%- comment -%}
      Construimos la ETIQUETA del principal a partir de producto.variationAttributes (si existen):
      - Tomamos solo los "value" y los unimos con " - "
      - Fallback: "Modelo principal"
      {%- endcomment -%}
      {%- capture principal_label -%}
        {%- if producto.variationAttributes and producto.variationAttributes.size > 0 -%}
          {%- assign vals = producto.variationAttributes | map: 'value' -%}
          {{ vals | join: ' - ' }}
        {%- else -%}
          Modelo principal
        {%- endif -%}
      {%- endcapture -%}
      {%- assign principal_label = principal_label | strip -%}

      <div class="selector-variantes" role="group" aria-label="Selecciona variante">

        <!-- Botón del MODELO PRINCIPAL (marcado por defecto) -->
        <button
          type="button"
          class="var-btn"
          aria-pressed="true"
          onclick="onVariantClick(this)"
          role="button"
          tabindex="0"
          title="{{ principal_label | escape }}"
          data-title="{{ principal_label | escape }}"
          data-imagen="{{ producto.imagen }}"
          data-enlace="{{ producto.enlace }}"
          data-precio="{{ producto.precio | default: '' }}"
          data-precio-original="{{ producto.precioOriginal | default: '' }}"
          {% if producto.imagenesVariantes %}
            data-imagenes='{{ producto.imagenesVariantes | jsonify | escape }}'
          {% endif %}
        >
          {% if producto.imagen %}
            <img src="{{ producto.imagen }}" alt="{{ principal_label | escape }}" loading="lazy" />
          {% endif %}
          <span class="var-label">{{ principal_label }}</span>
        </button>

        <!-- Botones de VARIANTES (ninguno marcado por defecto) -->
        {%- for v in producto.variantes -%}
          {%- capture v_label -%}
            {%- if v.variationAttributes and v.variationAttributes.size > 0 -%}
              {%- assign vals = v.variationAttributes | map: 'value' -%}
              {{ vals | join: ' - ' }}
            {%- else -%}
              Variante {{ forloop.index }}
            {%- endif -%}
          {%- endcapture -%}
          {%- assign v_label = v_label | strip -%}

          <button
            type="button"
            class="var-btn"
            aria-pressed="false"
            onclick="onVariantClick(this)"
            role="button"
            tabindex="0"
            title="{{ v_label | escape }}"
            data-title="{{ v_label | escape }}"
            data-imagen="{{ v.imagen | default: producto.imagen }}"
            data-enlace="{{ v.enlace | default: producto.enlace }}"
            data-precio="{{ v.precio | default: '' }}"
            data-precio-original="{{ v.precioOriginal | default: '' }}"
            {% if v.imagenesVariantes %}
              data-imagenes='{{ v.imagenesVariantes | jsonify | escape }}'
            {% endif %}
          >
            {% if v.imagen %}
              <img src="{{ v.imagen }}" alt="{{ v_label | escape }}" loading="lazy" />
            {% endif %}
            <span class="var-label">{{ v_label }}</span>
          </button>
        {%- endfor -%}
      </div>
      {%- endif -%}

      <div class="imagen-con-miniaturas">
        <div class="lupa-imagen"
          onmousemove="moverZoomFlotante(event, this)"
          onmouseenter="mostrarZoomFlotante(this)"
          onmouseleave="ocultarZoomFlotante(this)">
          <a href="{{ producto.enlace }}" target="_blank" rel="nofollow sponsored">
            <img
              id="imagen-principal-{{ forloop.index }}"
              class="principal"
              src="{{ producto.imagen }}"
              data-zoom="{{ producto.imagen }}"
              width="{{ producto.imagenWidth }}"
              height="{{ producto.imagenHeight }}"
              alt="{{ producto.nombre }}"
              loading="lazy"
            />
          </a>
          <div class="zoom-flotante"></div>
        </div>

        <div class="galeria-miniaturas">
          <img
            src="{{ producto.imagen }}"
            data-src="{{ producto.imagen }}"
            class="activa"
            onclick="seleccionarMiniatura(this)"
            width="{{ producto.imagenWidth }}"
            height="{{ producto.imagenHeight }}"
            alt="Imagen principal de {{ producto.nombre }}"
            loading="lazy"
          />
          {% for variante in producto.imagenesVariantes %}
            <img
              src="{{ variante.url }}"
              data-src="{{ variante.url }}"
              onclick="seleccionarMiniatura(this)"
              width="{{ variante.width }}"
              height="{{ variante.height }}"
              alt="Variante de {{ producto.nombre }}"
              loading="lazy"
            />
          {% endfor %}
        </div>
      </div>

      <p class="valoracion-html" style="font-weight: bold; color: #e67e22;">⭐ Valoración del experto: {{ producto.valoracion }}/5</p>

      {% if producto.precio or producto.precioOriginal %}
      <p class="precio-producto" style="margin-top: 6px;">
        <span style="color: #1a8917; font-weight: bold;">Precio actual:</span>
        <span class="precio-actual" style="font-size: 1.2em; font-weight: bold; color: #1a8917; margin-left: 5px;">
          {{ producto.precio }}
        </span>
        <span class="precio-original"
              style="margin-left: 12px; font-size: 1.1em; font-weight: 600; color: #c0392b;
                     text-decoration: line-through; white-space: nowrap; {% if producto.precioOriginal == nil or producto.precioOriginal == 'No especificado' %}display:none{% endif %};">
          {% if producto.precioOriginal and producto.precioOriginal != "No especificado" %}
            Antes: {{ producto.precioOriginal }}
          {% endif %}
        </span>
      </p>
      {% endif %}

      <p class="descripcion-review">{{ producto.descripcion | markdownify }}</p>

      {% if producto.caracteristicas %}
        <h4>Principales características:</h4>
        <ul class="bullets-review">
          {% for item in producto.caracteristicas %}
            <li>{{ item }}</li>
          {% endfor %}
        </ul>
      {% endif %}

      <a class="boton boton-compra" href="{{ producto.enlace }}" style="min-height:44px" target="_blank" rel="nofollow sponsored">{{ datos.emoji }} Ver oferta actual en Amazon</a>
    </article>

    {% unless forloop.last %}
      <div class="separador-producto"></div>
    {% endunless %}
  {% endfor %}
</div>
